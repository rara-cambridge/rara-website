(()=>{"use strict";var e={d:(t,i)=>{for(var o in i)e.o(i,o)&&!e.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:i[o]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};function i(e,t){if(!e)throw new Error(`${t} is not available on window (CDN not loaded)`);return e}e.r(t),e.d(t,{mount:()=>C});const o=window.maplibregl;class n{#e;#t;#i;#o;#n;constructor(e,t){this.#e=t,this.#t=e,this.#i=null,this.#o=!1,this.#n=!1}get visibleDynamic(){return this.#o}set visibleDynamic(e){this.#o=e,this.#r()}get visibleStatic(){return this.#n}set visibleStatic(e){this.#n=e,this.#r()}setData(e){"Point"===e.geometry.type&&(this.#i=new o.Popup({closeButton:!1,closeOnClick:!1}),this.#i.setLngLat(new o.LngLat(e.geometry.coordinates[0],e.geometry.coordinates[1])).setHTML(e.properties.title).addTo(this.#t.map),this.#r())}#r(){const e=this.visibleDynamic||this.visibleStatic;this.#i&&(this.#i.getElement().style.visibility=e?"visible":"hidden")}}const r=new WeakMap;class s{#s;#l;constructor(e){this.#s={},this.#l=e,function(e,t){r.set(e,t)}(e,this)}get map(){return this.#l}getPopup(e){return e in this.#s||this.#a(e),this.#s[e]}#a(e){const t=new n(this,e);return this.#s[e]=t,t}}class l{#c;constructor(e,t){this.#c=t,console.log("order",t),e.on("load",()=>{e.addSource("empty",{type:"geojson",data:{type:"FeatureCollection",features:[]}});for(let t=this.#c.length-1;t>=0;t--)e.addLayer({id:`z-${t}`,type:"symbol",source:"empty"},t===this.#c.length-1?void 0:`z-${t+1}`)})}getPosition(e){if(!this.#c.includes(e))throw new Error(`Layer ${e} not included as a sortable layer`);return`z-${this.#c.indexOf(e)}`}}const a="%{RARA_MAPS}";function c(e){return e.startsWith(a)?raraMapsData.baseUrl+e.slice(a.length):e}function d(e,t,i,o,{color:n="black",onEnter:s=null,onLeave:l=null,onClick:a=null,staticPopups:d=!1,visible:p=!0}){e.on("load",async()=>{const u=await e.loadImage(c(`%{RARA_MAPS}/assets/icons/pin-${n}.png`));e.addImage(t,u.data);const y=function(e){return r.get(e)}(e);if(i.features.forEach(e=>{const t=e?.properties?.id??null;if(t){const i=y.getPopup(t);i.setData(e),d&&(i.visibleStatic=!0)}}),e.addSource(t,{type:"geojson",data:i}),e.addLayer({id:t,type:"symbol",source:t,layout:{"icon-image":t,"icon-size":1,"icon-allow-overlap":!0,visibility:p?"visible":"none"}},o),!d){let i,o;e.on("mousemove",t,t=>{const n=t.features[0],r=n.geometry;if("Point"===r.type){const l=r.coordinates.toString();if(o!==l){o=l,e.getCanvas().style.cursor="pointer";const a=r.coordinates.slice();for(;Math.abs(t.lngLat.lng-a[0])>180;)a[0]+=t.lngLat.lng>a[0]?360:-360;i&&(y.getPopup(i).visibleDynamic=!1),i=n?.properties?.id??null,i&&(y.getPopup(i).visibleDynamic=!0,s&&s(i))}}}),e.on("mouseleave",t,()=>{const t=i;e.getCanvas().style.cursor="",y.getPopup(i).visibleDynamic=!1,i=void 0,o=void 0,l&&l(t)})}a&&e.on("click",t,e=>{const t=e.features[0],i=t?.properties?.id??null;i&&a(i)})})}const p=[];let u=null;const y="bottom-left";function g(e,t,i,n,r,{attribution:s=null,opacity:l=1,visible:a=!0}){e.on("load",()=>{e.addSource(t,{type:"image",url:i,coordinates:n}),e.addLayer({id:t,type:"raster",source:t,paint:{"raster-opacity":l??.5},layout:{visibility:a?"visible":"none"}},r),s&&function(e,t){p.includes(t)||p.push(t),e&&u&&e.removeControl(u),u=new o.AttributionControl({compact:!0,customAttribution:`<br>${p.join("<br>")}`}),e.addControl(u,y);const i=document.getElementsByClassName(`maplibregl-ctrl-${y}`)[0].getElementsByTagName("details")[0];i.classList.remove("maplibregl-compact-show"),i.removeAttribute("open")}(e,s)})}const{Map:b,NavigationControl:m,FullscreenControl:h,ScaleControl:v}=i(window.maplibregl,"maplibregl");const f=i(window.turf,"turf");const w="rara-maps-lib-root",P="boundary_radius";async function S(){try{const e=await fetch(c("%{RARA_MAPS}/build/data.json"));if(!e.ok)throw new Error("Network error");const t=await e.json(),i={...t,view:t.views.find(e=>e.id===P)},n=i.lines.find(e=>(e?.properties?.id??null)===i.view.app.route),r=function(e,t,{onLocationClick:i=null,onLocationEnter:o=null,onLocationLeave:n=null}){const r={...t.view.config,style:"string"==typeof t.view.config.style?c(t.view.config.style):t.view.config.style,container:e,attributionControl:!1},a=new b(r),p=t.attributions,u=(new s(a),new l(a,t.view.layers.map(e=>e.id)));return!1!==r?.showControls&&(a.addControl(new m({visualizePitch:!0,visualizeRoll:!0,showZoom:!0,showCompass:!0})),a.addControl(new h)),a.addControl(new v,"bottom-right"),t.view.layers.forEach(e=>{if("buildings"===e.type&&function(e,t,{visible:i=!0}){e.on("load",()=>{const o=e.getStyle().layers;let n;for(let e=0;e<o.length;e++)if("symbol"===o[e].type&&"layout"in o[e]&&o[e].layout["text-field"]){n=o[e].id;break}e.addSource(t,{url:"https://tiles.openfreemap.org/planet",type:"vector"}),e.addLayer({id:t,source:t,"source-layer":"building",type:"fill-extrusion",minzoom:15,filter:["!=",["get","hide_3d"],!0],layout:{visibility:i?"visible":"none"},paint:{"fill-extrusion-color":["interpolate",["linear"],["get","render_height"],0,"lightgray",200,"royalblue",400,"lightblue"],"fill-extrusion-height":["interpolate",["linear"],["zoom"],15,0,16,["get","render_height"]],"fill-extrusion-base":["case",[">=",["get","zoom"],16],["get","render_min_height"],0]}},n)})}(a,e.id,{visible:e.visible}),"line"===e.type){const i=t.lines.find(t=>(t?.properties?.id??null)===e.id);!function(e,t,i,o,{color:n="black",dashed:r=!1,visible:s=!0}){e.on("load",()=>{e.addSource(t,{type:"geojson",data:i}),e.addLayer({id:t,type:"line",source:t,layout:{"line-join":"round","line-cap":"round",visibility:s?"visible":"none"},paint:{"line-color":n,"line-width":6,"line-dasharray":[3,r?3:0]}},o)})}(a,e.id,i,u.getPosition(e.id),{color:e.color,dashed:e.dashed,visible:e.visible})}if("locations"===e.type){const r=t.locations[e.id];d(a,e.id,r,u.getPosition(e.id),{color:e.color,visible:e.visible,onClick:i??null,onEnter:o??null,onLeave:n??null})}if("overlay"===e.type){const i=t.overlays.features.find(t=>(t?.properties?.id??null)===e.id);"Polygon"===i.geometry.type&&g(a,e.id,c(i.properties.url),i.geometry.coordinates,u.getPosition(e.id),{attribution:!1!==r?.showControls&&i.properties.attribution?p[i.properties.attribution]:null,opacity:1,visible:e.visible})}"point"===e.type&&a.on("load",()=>{a.addSource(e.id,{type:"geojson",data:{type:"Feature",properties:{},geometry:{type:"Point",coordinates:[0,0]}}}),a.addLayer({id:e.id,source:e.id,type:"circle",paint:{"circle-radius":10,"circle-color":"#ff0000","circle-stroke-width":2,"circle-stroke-color":"white"}},u.getPosition(e.id))})}),a}(w,i,{});r.on("idle",()=>{const e=document.querySelector("#rara-maps-lib-root img");e&&e.classList.add("hidden"),function(e,t,i,{autoStart:n=!0}={}){let r=null;const s=f.lineString(i),l=f.point(t),a=()=>{r=r||Date.now();const i=(Date.now()-r)%3e4,c=f.along(s,f.length(s)*i/3e4).geometry.coordinates,d=f.distance(l,c,{units:"meters"}),p=f.bearing(l,c),u=d+500,y=f.destination(l,u,p,{units:"meters"}).geometry.coordinates;e.jumpTo(e.calculateCameraOptionsFromTo(new o.LngLat(y[0],y[1]),300,new o.LngLat(t[0],t[1]))),n&&requestAnimationFrame(a)};a()}(r,i.view.config.center,n.geometry.coordinates,{autoStart:!0})})}catch(e){console.log(`Network error: ${e}`)}}function C(){S()}document.addEventListener("DOMContentLoaded",C),window.raraMaps=t})();